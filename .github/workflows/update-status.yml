name: Update Status

on:
  push:
    paths:
      - 'data/*.json'
  workflow_dispatch:

jobs:
  update-status:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Update UPDATE_STATUS.md
        run: |
          const fs = require('fs');
          const path = require('path');
          const { execSync } = require('child_process');
          
          // Get today's date in DD/MM/YYYY format
          const today = new Date();
          const dateStr = String(today.getDate()).padStart(2, '0') + '/' + 
                          String(today.getMonth() + 1).padStart(2, '0') + '/' + 
                          today.getFullYear();
          
          // Get modified files
          let modifiedFiles = [];
          try {
            const output = execSync('git diff --name-only HEAD~1 HEAD', { encoding: 'utf-8' });
            modifiedFiles = output.trim().split('\n').filter(f => f.startsWith('data/') && f.endsWith('.json') && f.length > 0);
          } catch {
            try {
              const output = execSync('git diff --name-only HEAD', { encoding: 'utf-8' });
              modifiedFiles = output.trim().split('\n').filter(f => f.startsWith('data/') && f.endsWith('.json') && f.length > 0);
            } catch {
              console.log('No modified files detected');
            }
          }
          
          console.log('Modified files:', modifiedFiles);
          
          if (modifiedFiles.length === 0) {
            console.log('No data files modified');
            process.exit(0);
          }
          
          // Read UPDATE_STATUS.md
          let content = fs.readFileSync('UPDATE_STATUS.md', 'utf-8');
          console.log('Original content:', content);
          
          // Map filenames to display names
          const fileMap = {
            'data/ammunition.json': 'Ammunition',
            'data/hideout.json': 'Hideout',
            'data/items.en.json': 'Items',
            'data/item_presets.json': 'Item Presets',
            'data/levels.json': 'Levels',
            'data/maps.json': 'Maps',
            'data/quests.json': 'Quests',
            'data/storyline.json': 'Storyline',
            'data/traders.json': 'Traders'
          };
          
          // Update dates for modified files
          modifiedFiles.forEach(file => {
            const displayName = fileMap[file];
            console.log('Processing:', file, '->', displayName);
            
            if (displayName) {
              // Use a more robust approach
              const lines = content.split('\n');
              const updatedLines = lines.map(line => {
                if (line.includes(`[${displayName}]`) && line.includes(file)) {
                  // Replace the date at the end of the line
                  return line.replace(/(\d{2}\/\d{2}\/\d{4})(\s*)$/, `${dateStr}$2`);
                }
                return line;
              });
              content = updatedLines.join('\n');
              console.log('Updated line for:', displayName);
            }
          });
          
          // Write back
          fs.writeFileSync('UPDATE_STATUS.md', content);
          console.log('Updated UPDATE_STATUS.md with date:', dateStr);
          console.log('New content:', content);
        shell: node {0}
      
      - name: Commit and push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add UPDATE_STATUS.md
          git diff --cached --exit-code UPDATE_STATUS.md > /dev/null || (git commit -m "Update status for modified data files" && git push)
